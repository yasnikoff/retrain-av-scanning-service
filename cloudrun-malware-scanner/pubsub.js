const { PubSub } = require('@google-cloud/pubsub');

class PubSubClient {
  async config({ projectId, deadLetterTopicName }) {
    this.projectId = projectId;
    this.client = new PubSub({ projectId });
    const topics = (await this.client.getTopics()) || [];
    this.deadLetterTopic = topics.filter(
      (topic) => topic.name === deadLetterTopicName
    )[0];
  }

  get isConfigured() {
    return this.client && this.deadLetterTopic && this.projectId && true;
  }

  async reportFailedScan(name, bucket, size = null, cause = null) {
    if (!this.isConfigured) {
      return;
    }
    try {
      const data = { name, bucket, size, cause };
      await this.topic.publishJSON({ data });
    } catch (e) {
      console.error(`Can't publish to the dead letter topic: ${e?.message}`);
    }
  }
}

exports.PubSubClient = PubSubClient;
